<!DOCTYPE html>
<html>
<head>
  <title>小塔在干嘛喵</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #map {
      width: 100vw;
      height: 100vh;
      background: url('map.jpg') no-repeat center/cover;
      position: relative;
    }

    /* 小人基础样式 */
    #person {
      width: 50px;
      height: 50px;
      position: absolute;
      transition: all 0.5s ease;
      background: url('person.jpg') no-repeat center/contain; /* 默认移动时图片 */
    }

    /* 四个目标位置样式 */
    .location1 { left: 15%; top: 30%; }
    .location2 { left: 70%; top: 45%; }
    .location3 { left: 40%; top: 60%; }
    .location4 { left: 55%; top: 20%; }
    /* 管理员面板 */
    #adminPanel {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map">
    <div id="person"></div>
  </div>

  <div id="adminPanel" style="display: none;">
    <select id="location">
      <option value="location1">宿舍</option>
      <option value="location2">食堂</option>
      <option value="location3">教室</option>
      <option value="location4">图书馆</option>
    </select>
    <button onclick="updateLocation()">更新位置</button>
  </div>

  <script>
    // Firebase配置
    const firebaseConfig = {
      apiKey: "AIzaSyAIe2Th7xdexrh1ZhnxCuH-or8mspMYpDk",
      authDomain: "tartarus-3e705.firebaseapp.com",
      databaseURL: "https://tartarus-3e705-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tartarus-3e705",
      storageBucket: "tartarus-3e705.firebasestorage.app",
      messagingSenderId: "192253876792",
      appId: "1:192253876792:web:56ff2effe68b2b1aaa64cd",
      measurementId: "G-36QLSB4CFQ"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 位置-图片映射配置
    const locationImages = {
      location1: 'a.jpg',
      location2: 'b.jpg',
      location3: 'c.jpg',
      location4: 'd.jpg'
    };

    // 当前状态变量
    let isMoving = false;
    let currentLocation = '';

    database.ref('location').on('value', (snapshot) => {
      const newLocation = snapshot.val() || 'location1';
      const person = document.getElementById('person');
      
      if (newLocation !== currentLocation) {
        // 开始移动时设置默认图片
        isMoving = true;
        person.style.backgroundImage = "url('person.jpg')";
        
        // 添加过渡结束监听
        person.addEventListener('transitionend', function handler() {
          // 到达目标位置后切换图片
          person.style.backgroundImage = `url(${locationImages[newLocation]})`;
          person.removeEventListener('transitionend', handler);
          isMoving = false;
        }, { once: true });

        // 更新位置类名触发动画
        person.className = newLocation;
        currentLocation = newLocation;
      }
    });

    // 预加载所有图片
    function preloadImages() {
      const images = ['person.jpg', ...Object.values(locationImages)];
      images.forEach(src => new Image().src = src);
    }
    window.onload = preloadImages;

    // 管理员更新位置
    function updateLocation() {
      const password = prompt("请输入管理员密码:");
      if (password !== "OOO") return;

      const selectedLocation = document.getElementById('location').value;
      database.ref('location').set(selectedLocation);
    }

    // 显示管理员界面
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('admin') === 'true') {
      document.getElementById('adminPanel').style.display = 'block';
    }
  </script>
</body>
</html>